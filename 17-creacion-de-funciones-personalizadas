-- =============================================
-- FUNCIONES PERSONALIZADAS - FarmaciaMiBarrio
-- Funciones de Negocio y Cálculos
-- =============================================

USE FarmaciaMiBarrio;
GO

PRINT '========================================';
PRINT 'CREANDO FUNCIONES PERSONALIZADAS';
PRINT '========================================';
PRINT '';

-- Agregado GO antes de cada CREATE FUNCTION para evitar error de primera instrucción

-- FUNCIÓN: Calcular edad desde fecha de nacimiento
PRINT 'Creando función fn_CalcularEdad...';
GO

CREATE OR ALTER FUNCTION dbo.fn_CalcularEdad (@FechaNacimiento DATE)
RETURNS INT
AS
BEGIN
    RETURN DATEDIFF(YEAR, @FechaNacimiento, GETDATE()) - 
           CASE 
               WHEN MONTH(@FechaNacimiento) > MONTH(GETDATE()) 
                    OR (MONTH(@FechaNacimiento) = MONTH(GETDATE()) 
                        AND DAY(@FechaNacimiento) > DAY(GETDATE()))
               THEN 1 
               ELSE 0 
           END;
END;
GO

PRINT 'Función fn_CalcularEdad creada';

-- FUNCIÓN: Obtener stock total de un producto en todas las sucursales
PRINT 'Creando función fn_StockTotalProducto...';
GO

CREATE OR ALTER FUNCTION dbo.fn_StockTotalProducto (@ProductoID INT)
RETURNS INT
AS
BEGIN
    DECLARE @StockTotal INT;
    
    SELECT @StockTotal = ISNULL(SUM(Existencia), 0)
    FROM Inventario
    WHERE ProductoID = @ProductoID;
    
    RETURN @StockTotal;
END;
GO

PRINT 'Función fn_StockTotalProducto creada';

-- FUNCIÓN: Calcular total de ventas de un empleado en un periodo
PRINT 'Creando función fn_VentasEmpleadoPeriodo...';
GO

CREATE OR ALTER FUNCTION dbo.fn_VentasEmpleadoPeriodo (
    @EmpleadoID INT,
    @FechaInicio DATE,
    @FechaFin DATE
)
RETURNS DECIMAL(18,2)
AS
BEGIN
    DECLARE @TotalVentas DECIMAL(18,2);
    
    SELECT @TotalVentas = ISNULL(SUM(Total), 0)
    FROM Ventas
    WHERE EmpleadoID = @EmpleadoID
      AND CAST(FechaVenta AS DATE) BETWEEN @FechaInicio AND @FechaFin
      AND Estado = 'COMPLETADA';
    
    RETURN @TotalVentas;
END;
GO

PRINT 'Función fn_VentasEmpleadoPeriodo creada';

-- FUNCIÓN: Verificar si un producto requiere reposición
PRINT 'Creando función fn_RequiereReposicion...';
GO

CREATE OR ALTER FUNCTION dbo.fn_RequiereReposicion (
    @ProductoID INT,
    @SucursalID INT
)
RETURNS BIT
AS
BEGIN
    DECLARE @Requiere BIT = 0;
    
    IF EXISTS (
        SELECT 1
        FROM Inventario i
        INNER JOIN Productos p ON p.ProductoID = i.ProductoID
        WHERE i.ProductoID = @ProductoID
          AND i.SucursalID = @SucursalID
          AND i.Existencia <= p.StockMinimo
    )
    BEGIN
        SET @Requiere = 1;
    END
    
    RETURN @Requiere;
END;
GO

PRINT 'Función fn_RequiereReposicion creada';

-- FUNCIÓN TABLA: Obtener productos más vendidos de una sucursal
PRINT 'Creando función fn_ProductosMasVendidos...';
GO

CREATE OR ALTER FUNCTION dbo.fn_ProductosMasVendidos (
    @SucursalID INT,
    @Top INT = 10
)
RETURNS TABLE
AS
RETURN
(
    SELECT TOP (@Top)
        p.ProductoID,
        p.CodigoProducto,
        p.Descripcion,
        SUM(dv.Cantidad) AS TotalVendido,
        SUM(dv.Subtotal) AS MontoTotal,
        COUNT(DISTINCT v.VentaID) AS NumeroVentas
    FROM DetalleVentas dv
    INNER JOIN Ventas v ON v.VentaID = dv.VentaID
    INNER JOIN Productos p ON p.ProductoID = dv.ProductoID
    WHERE v.SucursalID = @SucursalID
      AND v.Estado = 'COMPLETADA'
    GROUP BY p.ProductoID, p.CodigoProducto, p.Descripcion
);
GO

PRINT 'Función fn_ProductosMasVendidos creada';

-- FUNCIÓN TABLA: Obtener ventas por empleado en un periodo
PRINT 'Creando función fn_ReporteVentasEmpleado...';
GO

CREATE OR ALTER FUNCTION dbo.fn_ReporteVentasEmpleado (
    @FechaInicio DATE,
    @FechaFin DATE
)
RETURNS TABLE
AS
RETURN
(
    SELECT 
        e.EmpleadoID,
        e.DNI,
        e.Nombres + ' ' + e.Apellidos AS NombreCompleto,
        e.Cargo,
        s.NombreSucursal,
        COUNT(DISTINCT v.VentaID) AS NumeroVentas,
        SUM(v.Total) AS TotalVendido,
        AVG(v.Total) AS PromedioVenta,
        MIN(v.FechaVenta) AS PrimeraVenta,
        MAX(v.FechaVenta) AS UltimaVenta
    FROM Empleados e
    INNER JOIN Sucursales s ON s.SucursalID = e.SucursalID
    LEFT JOIN Ventas v ON v.EmpleadoID = e.EmpleadoID 
        AND CAST(v.FechaVenta AS DATE) BETWEEN @FechaInicio AND @FechaFin
        AND v.Estado = 'COMPLETADA'
    WHERE e.Activo = 1
    GROUP BY e.EmpleadoID, e.DNI, e.Nombres, e.Apellidos, e.Cargo, s.NombreSucursal
);
GO

PRINT 'Función fn_ReporteVentasEmpleado creada';

-- FUNCIÓN: Calcular margen de ganancia promedio por categoría
PRINT 'Creando función fn_MargenGananciaCategoria...';
GO

CREATE OR ALTER FUNCTION dbo.fn_MargenGananciaCategoria (@CategoriaID INT)
RETURNS DECIMAL(18,2)
AS
BEGIN
    DECLARE @MargenPromedio DECIMAL(18,2);
    
    SELECT @MargenPromedio = AVG(MargenGanancia)
    FROM Productos
    WHERE CategoriaID = @CategoriaID
      AND Activo = 1;
    
    RETURN ISNULL(@MargenPromedio, 0);
END;
GO

PRINT 'Función fn_MargenGananciaCategoria creada';

PRINT '';
PRINT 'Todas las funciones personalizadas creadas exitosamente';
PRINT '';
GO
